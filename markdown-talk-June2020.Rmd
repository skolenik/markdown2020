---
title: "Reproducible report generation using Markdown"
author: "Stas Kolenikov"
date: "June 8&ndash;9, 2020"
output: 
# rmdshower does not work with flextable
#  rmdshower::shower_presentation:
#    self_contained: true
#    ratio: 16x10
  xaringan::moon_reader:
    lib_dir: libs
    css: ["xaringan-themer.css"]
    nature:
      highlightStyle: solarized-dark
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
need_packages <- c("here", "knitr", "kableExtra", "flextable", "tidyverse", "xaringanthemer", 
                   "shiny", "countdown")
for( p in need_packages ) {
  library(p, character.only=TRUE)
}
```

```{r xaringan}
style_solarized_dark()
style_xaringan(
  background_color = '#000000',
  text_color       = '#b7c9d3',
  header_color     = '#DA291C',
  title_slide_text_color = '#DA291C',
  title_slide_background_color = '#DFD1A7',
  title_slide_background_image = 'AbtLogo2.png',
  title_slide_background_size	= '200px 100px',
  title_slide_background_position	= 'bottom 10px left 20px',
  inverse_text_color = '#000000',
  inverse_header_color = '#7566A0',
  inverse_background_color = '#DFD1A7',
  inverse_text_shadow = TRUE,
  background_image = 'AbtLogo2.png',
  background_size	= '90px 45px',
  background_position	= 'bottom 10px left 10px',
  link_color       = '#7566A0',
  code_inline_color = '#C3C6A8',
  code_highlight_color = '#E87722'
)
```

## Purposes

1. Introduce Markdown as a bare bones text-only format that allows formatting text,
   inserting links, inserting images.
2. Introduce RMarkdown as a tool to weave together text and analysis (tables, figures,
   plots, individual numbers).
3. Demonstrate other uses of Markdown (Stata, Python notebooks, diagrams).
4. Demonstrate flexible / reproducible report generation with parametric Markdown templates
   and input parameters.
5. Provide resources for further professional development.

Helpful upfront knowledge: some R; some HTML

???

Active teaching goal: you would be able to produce basic Markdown documents;
passive goal: you would be able to understand Markdown syntax.

Need R because the best available vehicle is RStudio / RMarkdown. 
Markdown also works in Stata, and is integral to Python Jupyter notebooks.

Need HTML because the primary, and the most flexible and cute looking, output from
Markdown is into HTML.

---

## Focus on reproducibility

- Produce reports for several waves of data.
- Produce reports for the data that is being collected / cleaned.
- Produce updated analyses / updated text for academic papers.

Modern take: [literate programming](https://en.wikipedia.org/wiki/Literate_programming) 
tools based on plain text
- Markdown to code and to write up.
- GitHub to store versions of the code and the writeup, plus optionally the data.

Adopt sensible file storage structures, code documentation practices.

Avoid point and click; avoid copy and paste.

???

Reproducibility needs are all around us, whether we are in industry or in academia.
In my 20+ years of doing statistics, it has never been the case that the first analysis
I ran was the one ultimately reported / published / presented. Expect the work to be
repeated and redone, which means the code and the narrative need to be stored and recycled.
In my world of contract research, this typically involves updates to the data
with new methodology reports. In the academic world, this more often involves
a different analysis, e.g. in response to the adviser or the referee comments.

Literate programming is a concept that actually dates back to 1970s when 
Donald Knuth first wrote TeX as an example of a literate programming language.
In literate programming, a computer program is given an explanation of its logic 
in a natural language, such as English, interspersed with snippets of macros 
and traditional source code, from which executable code can be generated.

---

## Literate programming

> Let us change our traditional attitude to the construction of programs: 
> Instead of imagining that our main task is to instruct a computer what to do, 
> let us concentrate rather on explaining to humans what we want the computer to do.
> 
> â€” Donald E. Knuth, Literate Programming, 1984

---

## Abt reproducibility guidelines

As a part of the Abt Standardizations, we have a set of
[Abt Reproducibility Guidelines](https://abtassoc.sharepoint.com/sites/PropProj/KnowledgeHub/ProjectResources/Forms/Document%20Set/docsethomepage.aspx?ID=221&FolderCTID=0x0120D520004D4796F2693915459571CEAF63A49541&List=d31a478e-121d-4d59-a9d0-e8ecf37affbc&RootFolder=%2Fsites%2FPropProj%2FKnowledgeHub%2FProjectResources%2FCoding%20Standardization%20%2D%20Documentation%20and%20Reproducibility%20Resources&RecSrc=%2Fsites%2FPropProj%2FKnowledgeHub%2FProjectResources%2FCoding%20Standardization%20%2D%20Documentation%20and%20Reproducibility%20Resources)


---

## Why I am here

1996: learned LaTeX by forcing myself to do Econ homeworks in LaTeX; 
<br>learned HTML to produce my very first pages/websites.

Academia 2005&ndash;2008-ish: statistical simulations in Stata
summarizing results with the likes of

```
for j=1/5 {
  sum beta`k'
  file write " & " (r(mean)) " & " (r(sd) )
  count if abs( (beta`k' - true_beta`k')/se_beta`k' ) < invnorm(0.975)
  file write " & " (r(N)/_N*100) "\% \\" _n
}
```

2015-ish: was preparing to take a course on webscraping in R, brushed up R skills,
stumbled upon [R4DS](https://r4ds.had.co.nz/). Wrote my next weighting report in
Markdown, was blown away, and now do 98% of my R coding work in markdown.

???

As you can clearly see in this Stata code,
it summarizes the simulated means, standard deviations, and confidence intervals coverage,
and outputs them into a LaTeX table.

---

## My take on software

- One rectangular data set, analysis leading up to a handful of regression tables: Stata
- Develop and deploy algorithms on web: Python, Java
- Produce reports: R

---

## Birds do it, bees do it

Do I need to say anything about the educated fleas??

https://medium.com/@urban_institute/r-is-the-best-programming-language-for-innovation-at-urban-155e2ebf5c74

https://medium.com/@urban_institute/iterated-fact-sheets-with-r-markdown-d685eb4eafce

https://medium.com/pew-research-center-decoded/using-tidyverse-tools-with-pew-research-center-survey-data-in-r-bdfe61de0909



---

## Building blocks of my workflow

- RMarkdown
- R tidyverse (pipes!)
- Version control
- Cheat sheets

Nicely packaged within RStudio

- Google and Twitter

---

## Copy-paste vs. markdown

![](docs/copy-paste.jfif)

---

class: inverse, center

# Basics of Markdown

---

## Markdown

![](docs/markdown-everywhere.jpg)

---

## Examples

Books in markdown: http://bookdown.org, https://r4ds.had.co.nz/

Dashboards in R markdown: [CRAN download gauge](https://gallery.shinyapps.io/cran-gauge/)

Diagrams: [Typora diagrams](http://support.typora.io/Draw-Diagrams-With-Markdown/)

Markdowns with several languages: [ICHPS 2020 Complex Surveys](
https://htmlpreview.github.io/?https://github.com/skolenik/ICHPS2020-svy/blob/master/ichps2020-svy.html)

Browser presentations: this webinar (show [the source](markdown-talk-June2020.Rmd)!)

---

## Markdown

When you make your text **bold**, or _italic_, or `paste(code, snippets)`, or create

- items in lists
- and more items
    * some of which may be nested

you are _marking_ certain elements of your text to be formated in a special way.
(The heading above is also a marked text.)

Markdown modifies this to a very bare bones, text-only, no-mouse-selection-needed process.
The name is supposed to be a play on "markup" which is a technical term to describe
languages like HTML, XML, or LaTeX.

https://daringfireball.net/projects/markdown/syntax

---

## Markdown elements

```

Pieces of `code`

Text in _italics_

Text in **bold**

### Heading 3

- unnumbered item
    + nested list item

1. numbered item

[text of a link](http://some.url.com/with/path)

![](some_meme_file.jpg)

```

---

## Exercise

1. Go to [SlackEdit](https://stackedit.io/app#) online editor.
2. Open/create a new file (click `r icon('folder', lib='font-awesome')` to open the file menu).
3. Enter the following in the editor with formatting, watch the rendered version in the right pane:

# Header 1: This is my first markdown file.

Hi, I am **Stas** _Kolenikov_. I use Markdown to:

- create simple documents
    + take notes
    + make to-do lists

```{r exercise1_timer}
countdown(minutes=5)
```

---

## Solution

```
# This is my first markdown file.

Hi, I am **FirstName** _LastName_. I am using Markdown to:

- create simple documents
    + take notes
    + make to-do lists
```

Feel free to carry on and do more of the basic markdown tutorials at https://www.markdowntutorial.com/.

---

class: inverse

# Markdown + code

---

## R Markdown

Additionally, R and some other languages can 

- incorporate source code 
- incorporate the output, such as numbers, tables, and plots

... into Markdown documents. 
(You are explaining to other humans, including your future self,
what you want to do with the data!)

Code chunks:

```` 
```r

# some code here

``` 
````

Inline code:

The total number of observatsions is 
<code>&#96;</code>`r paste0(rawToChar(as.raw(96)),"r nrow(mydata)", rawToChar(as.raw(96)))`
<code>&#96;</code>.

---

## Aside: tidy pipes 

![](docs/magritr.png)

R `library(magritr)` introduced a pipe operator `%>%` that allows stringing 
of manipulations / adjustment of formatting options. It helps isolating steps
in data prep, analysis, and creation of graphs (`library(ggplot2)` although it uses
`+` for piping) and tables.

[Treachery of Images](https://en.wikipedia.org/wiki/The_Treachery_of_Images)

---

## KFF tracking poll

[Simplified KFF report: source](KFF-report.Rmd)

[Simplified KFF report: rendered](KFF-report.html)

---

## To learn more: cheatsheets

https://www.rstudio.com/resources/cheatsheets/

---

## Graphics

```{r, echo=FALSE, fig.width=10, fig.height=5, warning=FALSE}
readRDS(here('q1plot.Rds'))
```

```
library(ggplot2)
```

and a myriad of extentions to it. Graphic output of a chunk is inserted.

---

## Tables

```{r}
readRDS(here('KFF_MOE.Rds')) %>% 
  select(Group, `N (unweighted)`,MOE) %>%  
  filter(str_detect(Group, "[s]") ) %>%
  kable() %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

A lot of output looks like a table already: regression results, cross-tabs.
Other research results may be assembled as small data sets of summary statistics.

```
# aimed at HTML
library(kableExtra)
library(gt)
# aimed more at MS products
library(flextable)
```

---

## library(kableExtra)

Compared to others, produces much nicer tables in HTML, but MS Word breaks down.

```{r MOE_kableExtra}
readRDS(here('KFF_MOE.Rds')) %>% 
  mutate(`N (unweighted)` = cell_spec(`N (unweighted)`, "html", 
                            font_size = spec_font_size(sqrt(neff), end=20),
                            align = 'c') ) %>% # fancy sample size
  select(Group, `N (unweighted)`,MOE) %>%  
  kable(escape=FALSE) %>% 
  row_spec(0,color='white',background="#48A9C5") %>%  # header colors
  row_spec(2,align="center") %>%                      # put "Party ID" in the center
  row_spec(c(2,4,6), background = '#3e4040') %>%      # alternating rows 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

[Documentation vignette 
here.](https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html)

---

## library(kableExtra)

Compared to others, produces much nicer tables in HTML, but MS Word breaks down.

````
```r MOE_kableExtra
readRDS(here('KFF_MOE.Rds')) %>% 
  mutate(`N (unweighted)` = cell_spec(`N (unweighted)`, "html", 
            font_size = spec_font_size(sqrt(neff), end=20),
            align = 'c') ) %>% # fancy sample size
  select(Group, `N (unweighted)`,MOE) %>%  
  kable(escape=FALSE) %>% 
  row_spec(0,color='white',background="#48A9C5") %>%  # header colors
  row_spec(2,align="center") %>%                      # center Party ID
  row_spec(c(2,4,6), background = '#3e4040') %>%      # alternate rows 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```
````

---

## library(flextable)

Compared to others, produces reasonably nice table in both HTML and MS Word.

```{r MOE_flextable}
readRDS(here('KFF_MOE.Rds')) %>% 
  select(Group, `N (unweighted)`,MOE) %>%  
  flextable() %>%             # convert to flextable
  align(j=1,align="left") %>%         # change alignment
  align(i=2,j=1,align="center") %>%   # put "Party ID" in the center
  bg(bg="#48A9C5", part="header") %>% # header colors
  color(color="white", part="header") %>%
  bg(bg="white", part="body") %>%
  autofit()                           # some magic in column widths
```

[Overview here](https://davidgohel.github.io/flextable/articles/overview.html)

---

## library(flextable)

````
```r MOE_flextable
readRDS(here('KFF_MOE.Rds')) %>% 
  select(Group, 'N (unweighted)', MOE) %>%  
  flextable() %>%             # convert to flextable
  align(j=1,align="left") %>%         # change alignment for Group
  align(i=2,j=1,align="center") %>%   # put "Party ID" in the center
  bg(bg="#48A9C5", part="header") %>% # header colors
  color(color="white", part="header") %>%
  bg(bg="white", part="body") %>%
  autofit()                           # some magic in column widths
```
````

---

class: inverse

# Customizing markdown output

---

## R chunk options

```` 
```{r ChunkName, echo=FALSE} 

# some code here that I don't want to see in the final output

``` 
````

Review the chunk options in 
[RStudio cheatsheet](https://github.com/rstudio/cheatsheets/raw/master/rmarkdown-2.0.pdf)

---

## Parametric markdown documents

The more advanced forms of markdown documents use inputs/parameters.

- Output format: HTML (the most flexible, and the only interactive), Word, PDF (requires LaTeX)
- Task to perform: analysis vs. reporting the results
- Input data files
- Formatting specifications (e.g. digits to report)

Parametric markdowns are to be used from command line / R scripts:

```
rmarkdown::render( ..., 
    params=list(todo='analysis',
          input_data='KFF-April2019.sav'))
```

---

## Parametric markdown: output

```
filename_stub <- 'MyReport'
rmarkdown::render(
  input=paste0(filename_stub,.'Rmd'), 
         # input file
  output_file=I(paste0(filename_stub,'-',Sys.Date())),  
         # output file with date embedded, no extension
  output_format='docx_document')                        
         # output format; the extension is inferred from it
  # output_format='html_document')                      
         # alternative output format; here, commented out
)  
```

PDF output requires a LaTeX compiler; not presented in this talk.

---

## Parametric markdown: YAML header

```
---
title: "Reproducible report generation using Markdown"
author: "Stas Kolenikov"
date: `r Sys.Date()`
output:
  html_output:
    code_folding: hide
    toc: TRUE
  word_document:
    reference_docx: Abt_2018_Report_Template.docx
---
```

---

## Parametric markdown: YAML header

```
---
title: "Reproducible report generation using Markdown"
author: "Stas Kolenikov"
date: `r Sys.Date()`
params:
  todo: analysis
  # todo: reporting
  data_source: April2019.dta
  # data_source: Mar2019.dta
  digits: 4
---
```

---

## Parametric markdown: tasks to do

````
```r long_analysis
if (params$todo=="analysis") {
  # mixed modeling code that takes hours to execute
  model1 <- ...
  saveRDS(model1, file='model1.Rds')
} else if (params$todo=="reporting") {
  model1 <- readRDS(file='model1.Rds')
}
```
````

---

## Parametric markdown: varying data

Explicit naming:

````

---
params:
  data_source: KFF-April2019.sav
---

```r read_data
main_data <- read.sav( params$data_source )
```

````

---

## Parametric markdown: varying data

Combining parts:

````
---
...
params:
  month: April
---

```r read_data_by_month
main_data <- read.sav( paste0( 'KFF-',params$month, '2019.sav' ) )
```
````

Which can be rendered with

```
filename_stub <- 'MyReport'
month         <- 'April'
rmarkdown::render(input=paste0(filename_stub,.'Rmd'),   # input file
  output_file=I(paste0(filename_stub,'-',month,'-',Sys.Date())),  
  output_format='docx_document'),                       # output format
  params=list(month=month)                              # pass parameters
)
```

---

class: inverse

# Markdown presentations

---

## Markdown presentations

Several libraries available, with slightly differing functionality (and ease of adjusting options):

- `ioslides` (probably the easiest to run)
    * presenter mode
    * custom CSS
- `slidy`
    * fixed timer per slide
- `shower` 
    * easier to create self-contained presentation HTML files
    * not compatible with `flextable`
- `xarnigan` (this presentation)
    * not compatible with `shiny` interactive elements
    * presenter mode

Slides are separated by `---` (separator line) or by `##` (Header 2).

Handouts: print from browser to PDF.

---

## Markdown presentations

[Abt colors:](https://abtassoc.sharepoint.com/departments/Comms/Documents/Abt-Brand-ID-Style-Guide.pdf)

````
style_solarized_dark()
style_xaringan(
  background_color = '#000000',
  text_color       = '#B7C9D3',
  header_color     = '#DA291C',
  title_slide_text_color          = '#DA291C',
  title_slide_background_color    = '#DFD1A7',
  title_slide_background_image    = 'AbtLogo2.png',
  title_slide_background_size	    = '200px 100px',
  title_slide_background_position	= 'bottom 10px left 20px',
  background_image     = 'AbtLogo2.png',
  background_size	     = '90px 45px',
  background_position	 = 'bottom 10px left 10px',
  link_color           = '#7566A0',
  code_inline_color    = '#C3C6A8',
  code_highlight_color = '#E87722'
)
````

---

class: inverse

# A few words about version control

---

## Reasons for markdown

1. Combine narrative and data analysis
2. Reproduce your work (reports, revisions)
3. Reuse the code with different options, sources, formatting, ...
4. Version control over the plain text

---

## Reasons for markdown: version control

![](docs/rainman.jpg)

---

## Version control

This talk:

- https://github.com/skolenik/markdown2020

VCS training, of sorts (~1.5 hrs)

- https://github.com/skolenik/shower-vcs

A complete introduction to using Git with RStudio

- https://happygitwithr.com/ by @JennyBryan

---

class: inverse

# Getting to use and rely on markdown

---

## One foot in front of the other

Gradual, incremental changes

- convert a section / 3-5 tables/plots to R/RMarkdown per monthly report
    * ask "how do I" questions on Abt MS Teams / Yammer, and/or
    * ask "how do I" questions on Twitter, and/or
    * ask "how do I" questions on RStudio community
- type your meeting notes in a markdown editor
    * Typora (offline)
    * SlackEdit (online)

---

## Pain points

Early on:
- Interface
- Command line and scripts
- Obscure error messages
- Multiple R syntaxes (base R, formulas, tidyverse)
- Too many resources

Intermediate to advanced:
- Labeled integers vs. strings vs. factor variables
- Package versioning and management

---

class: inverse

# Markdown and other languages

---

## Markdown in other languages

Stata: markstat

---

## Markdown in other languages

Python: markdown cells in notebooks

---

## Markdown in other languages

Diagrams: `mermaid` in Typora

---

## Other languages in RStudio

Python:

````
```r libraries
library(reticulate)
```

Do something in Python:

```python
import pandas as pd
flights = pd.read_csv('flights.csv')
```

Pass back to R:

```r
head( py$flights )
```

````

---

## Other languages in RStudio

Stata:

````
```r stata_engine
statapath <- "C:/Program Files/Stata16/Stata-MP.exe"
library(Statamarkdown)
knitr::opts_chunks$set(engine.path=list(stata=statapath))
```

Do something in Stata (`collectcode` option makes sure results are cumulative):

```stata, collectcode=TRUE
sysuse auto, clear
```

More Stata:

```stata
scatter mpg price
```

````

---

## Software citations

R version: `r R.version.string`.

Packages versions:

```{r package_versions, comment='- '}
for( p in need_packages ) {
  cat('library(',p, '):  version', as.character(packageVersion(p)), '\n')
}
```



---

## Thanks

Stas Kolenikov ([stas_kolenikov@abtassoc.com](stas_kolenikov@abtassoc.com))

Twitter [@StatStas](http://twitter.com/StatStas)
